<!DOCTYPE html>
<html>

    <head>
        <link type="text/css" rel="stylesheet" href="{{ url_for('static', filename='main.css') }}" media="all" />

        
        <script type="text/javascript" src="{{ url_for('static', filename='randomColor.js') }}"></script>
        <script type="text/javascript" src="//code.jquery.com/jquery-1.8.0.min.js"></script>
        <script>window.twttr = (function(d, s, id) {
          var js, fjs = d.getElementsByTagName(s)[0],
            t = window.twttr || {};
          if (d.getElementById(id)) return t;
          js = d.createElement(s);
          js.id = id;
          js.src = "https://platform.twitter.com/widgets.js";
          fjs.parentNode.insertBefore(js, fjs);
         
          t._e = [];
          t.ready = function(f) {
            t._e.push(f);
          };
         
          return t;
        }(document, "script", "twitter-wjs"));</script>

        <script type="text/javascript">
        poet = {
            recentLines : {
                maxLength: 15,
                list: Array(),
                add: function (item) {
                    $('<p>'+item+'</p>').hide()
                    .prependTo('#recent-tweets')
                    .slideDown('fast');

                    // var length = $('#left').children().length;
                        // console.log('haiku length: '+length)
                        if ($('#recent-tweets').children().length > this.maxLength) {
                            $('#recent-tweets p:last').slideDown('fast')
                            .remove();
                        }
                    // this.list.push(item)
                    // if (this.list.length > this.maxLength) {
                    //     this.list.shift()
                    // }
                }
            },

            activeUsers: {
                users: Object(),
                addUser: function (user) {
                    user.color = randomColor()
                    user.remainingLines = user.filtered_count
                    this.users[user.screen_name] = user
                    document.styleSheets[0].cssRules[0].cssText = '.user-'+user.screen_name+' { color: '+user.color+ '};'
                },
                
                colorForUser: function (user) {
                    return this.users[user].color
                },

                sawLineForUser: function (user) {
                    this.users[user].remainingLines--
                }
            },

            formatLine: function (line) {
                var classes = 'poem-line'
                if (line.info.special_user != null) {
                    classes = classes+' user-line user-'+line.special_user
                }
                return '<div class="'+classes+'"><a class="line-link" href="'+line.info.id_str+'">'+line.info.text+'</a></div>'
            },

            formatPoem: function (poem) {
                var lines = poem.lines.map(function(line) {
                        return poet.formatLine(line)
                        }).reduce(function(a, b) {
                            return a + b
                        });
                return '<div class="poem">'+lines+'</div>'
            },

            handleMessage: function (msg) {
                switch (msg.mtype) {
                    case "line":
                        this.recentLines.add(msg.body)
                        // $('#recent-tweets').html( this.recentLines.list.join('<br/>') )
                        break;
                    case "user-line":
                        this.recentLines.add(msg.body.text)
                        // $('#recent-tweets').html( this.recentLines.list.join('<br/>') )
                        console.log(msg)
                        this.activeUsers.sawLineForUser(msg.body.special_user)
                        break;
                    case "poem":
                        this.displayPoem(msg.body)
                        break;
                    case "track-user":
                        this.activeUsers.addUser(msg.body)
                        console.log('active users:')
                        console.log(this.activeUsers)
                        var formattedUser = '<div class="active-user user-'+msg.body.screen_name+'">'+msg.body.screen_name+'</div>'
                        $(formattedUser).hide()
                        .prependTo('.active-users')
                        .fadeIn('slow');
                        break;
                }
            },

            displayPoem: function (poem) {
                var formattedPoem = poet.formatPoem(poem)
                // formattedPoem.fadeIn(1000)
                switch (poem.poem_type) {
                    case "haiku":
                        $(formattedPoem).hide()
                        .prependTo('#left')
                        .slideDown('slow')

                        var length = $('#left').children().length;
                        console.log('haiku length: '+length)
                        if (length > 5) {
                            $('#left div.poem:last').fadeOut('slow')
                            .remove();
                        }
                        break;

                    case "limerick":
                        $(formattedPoem).hide()
                        .prependTo('#right')
                        .slideDown('slow')

                        var length = $('#right').length;
                        if (length > 3) {
                            $('#right:last-child').remove();
                        }
                        break;
                }
            }
        }
        </script>
        <script type="text/javascript">
            $(document).ready(
                    function() {
                        sse = new EventSource('/my_event_source');
                        sse.onmessage = function(message) {
                            // console.log(message)
                            try {
                                var msg = jQuery.parseJSON(message.data)
                            } 
                            catch (e) {
                                console.log(e)
                                console.log(message.data)
                            }
                            poet.handleMessage(msg)
                        }
                    });
        </script>
    </head>

    <body>

        <h2>poet.py</h2>
        <div id="recent-tweets">
        </div>
        <div class="wrapper">
        </div>
        <div class="active-users">null</div>
        <div class="wrapper">
            <div class="poem-container" id="left"></div>
            <div class="poem-container" id="right"></div>
                <!-- <div class="poem-container haiku">
                </div>
                <div class="poem-container limerick">
                </div> -->
                </div>
                <div id="user-list"></div>
        </div>
        <!-- <ul id="output">

        </ul> -->

    </body>

</html>